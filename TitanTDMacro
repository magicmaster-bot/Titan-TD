repeat task.wait() until game:IsLoaded() and game.Players.LocalPlayer and game.Players.LocalPlayer:FindFirstChild("PlayerGui")

local Players = game:GetService("Players")
local Rep = game:GetService("ReplicatedStorage")
local WS = game:GetService("Workspace")
local Http = game:GetService("HttpService")
local Plr = Players.LocalPlayer

local macro = {}
local recording = false
local folder = "TitanMacroSafe"
local selectedFile = nil
local startTime = 0

if not isfolder(folder) then makefolder(folder) end

local function getTime()
	return tick() - startTime
end

local function record(action, data)
	if recording then
		table.insert(macro, {
			Time = getTime(),
			Action = action,
			Data = data
		})
	end
end

local function startRecord()
	macro = {}
	startTime = tick()
	recording = true
end

local function stopRecord()
	recording = false
	local filename = folder .. "/Macro_" .. os.time() .. ".json"
	writefile(filename, Http:JSONEncode(macro))
end

local function loadMacro(path)
	local data = readfile(path)
	return Http:JSONDecode(data)
end

local function playMacro(data)
	for _, act in ipairs(data) do
		task.delay(act.Time, function()
			local a = act.Action
			if a == "Place" then
				Rep.Remotes.PlaceTower:FireServer(unpack(act.Data))
			elseif a == "Upgrade" then
				local path = WS
				for seg in string.gmatch(act.Data, "[^%.]+") do
					path = path:FindFirstChild(seg)
					if not path then return end
				end
				path:FireServer()
			elseif a == "Sell" then
				for _, v in pairs(getnilinstances()) do
					if v:IsA("RemoteEvent") and v.Name == "Sell" then
						v:FireServer()
						break
					end
				end
			elseif a == "Skip" then
				for _, v in pairs(getnilinstances()) do
					if v:IsA("RemoteEvent") and v.Name == "RemoteEvent" then
						v:FireServer(true)
						break
					end
				end
			end
		end)
	end
end

-- Remote Recorder (Safe polling method)
task.spawn(function()
	while true do
		if recording then
			debug.setmemorycategory("MacroPoll")
			local cons = getconnections(Rep.Remotes.PlaceTower.OnClientEvent)
			if #cons == 0 then
				Rep.Remotes.PlaceTower.OnClientEvent:Connect(function(...) end)
			end
			for _,v in pairs(Rep.Remotes:GetChildren()) do
				if v:IsA("RemoteEvent") then
					v.OnClientEvent:Connect(function(...) end)
				end
			end
			for _,v in pairs(getnilinstances()) do
				if v:IsA("RemoteEvent") and v.Name == "Sell" then
					v.OnClientEvent:Connect(function(...) end)
				end
			end
		end
		task.wait(1)
	end
end)

hookfunction(Instance.new("RemoteEvent").FireServer, newcclosure(function(self, ...)
	local args = {...}
	if recording then
		if self == Rep.Remotes:FindFirstChild("PlaceTower") then
			record("Place", args)
		elseif self.Name == "UpgradeRem" then
			record("Upgrade", self:GetFullName())
		elseif self.Name == "Sell" then
			record("Sell")
		elseif self.Name == "RemoteEvent" and args[1] == true then
			record("Skip")
		end
	end
	return self:FireServer(unpack(args))
end))

-- GUI
local gui = Instance.new("ScreenGui", Plr:WaitForChild("PlayerGui"))
gui.Name = "TitanMacroSafeGui"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.ZIndexBehavior = Enum.ZIndexBehavior.Global

local main = Instance.new("Frame", gui)
main.Size = UDim2.new(0, 420, 0, 280)
main.Position = UDim2.new(0.5, -210, 0.5, -140)
main.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
main.Active = true
main.Draggable = true

local title = Instance.new("TextLabel", main)
title.Size = UDim2.new(1, 0, 0, 30)
title.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
title.Text = "Titan TD Macro"
title.TextColor3 = Color3.new(1,1,1)
title.TextSize = 16
title.Font = Enum.Font.GothamBold

local toggleBtn = Instance.new("TextButton", gui)
toggleBtn.Size = UDim2.new(0, 80, 0, 30)
toggleBtn.Position = UDim2.new(0, 10, 0, 10)
toggleBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
toggleBtn.Text = "Toggle GUI"
toggleBtn.TextColor3 = Color3.new(1,1,1)
toggleBtn.Font = Enum.Font.Gotham
toggleBtn.TextSize = 14
toggleBtn.MouseButton1Click:Connect(function()
	main.Visible = not main.Visible
end)

local function createButton(text, pos, parent, callback)
	local b = Instance.new("TextButton", parent)
	b.Size = UDim2.new(0, 180, 0, 30)
	b.Position = pos
	b.Text = text
	b.Font = Enum.Font.Gotham
	b.TextSize = 14
	b.BackgroundColor3 = Color3.fromRGB(70,70,70)
	b.TextColor3 = Color3.new(1,1,1)
	b.BorderSizePixel = 0
	b.MouseButton1Click:Connect(callback)
	return b
end

createButton("Start Record", UDim2.new(0, 20, 0, 40), main, startRecord)
createButton("Stop & Save", UDim2.new(0, 220, 0, 40), main, stopRecord)

local scroll = Instance.new("ScrollingFrame", main)
scroll.Position = UDim2.new(0, 20, 0, 90)
scroll.Size = UDim2.new(1, -40, 0, 170)
scroll.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
scroll.BorderSizePixel = 0
scroll.ScrollBarThickness = 6
scroll.CanvasSize = UDim2.new(0, 0, 5, 0)

local layout = Instance.new("UIListLayout", scroll)
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding = UDim.new(0, 5)

for _, file in ipairs(listfiles(folder)) do
	if file:match("%.json$") then
		local name = file:match("([^/\\]+)%.json$")
		local btn = Instance.new("TextButton", scroll)
		btn.Size = UDim2.new(1, -10, 0, 30)
		btn.Text = name
		btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
		btn.TextColor3 = Color3.new(1,1,1)
		btn.Font = Enum.Font.Gotham
		btn.TextSize = 14
		btn.MouseButton1Click:Connect(function()
			local data = loadMacro(file)
			playMacro(data)
		end)
	end
end
